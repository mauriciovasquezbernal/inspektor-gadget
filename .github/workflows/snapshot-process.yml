name: Inspektor Gadget CI
env:
  GO_VERSION: 1.22.8
concurrency:
  group: ${{ github.ref }}
  # We do not want to cancel job in progress on main to be sure to catch new
  # regression as soon as they are introduced.
  cancel-in-progress: ${{ github.ref_name != 'main' }}
on:
  pull_request:
  push:
    branches:
    - main
    - 'release-*'
    - 'citest/**'
    tags:
    - 'v*'

permissions: read-all

# Jobs are given a level in a comment.
# Jobs of the same level run in parallel.
# Jobs of level N depend of, at least, one job on level N - 1 expect job whom
# level is 0.
jobs:
  test-snapshot-process:
    name: Test gadgets snapshot process
    #level 3
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runtime: [docker, containerd, cri-o]
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Setup go
      uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
      id: go
    - name: Setup minikube
      uses: ./.github/actions/setup-minikube
      with:
        runtime: ${{ matrix.runtime }}
        multi-node: true
    - name: Build kubectl-gadget.
      shell: bash
      run: |
        make IMAGE_TAG=latest kubectl-gadget
    - name: Deploy ig-k8s
      shell: bash
      run: |
        set -o pipefail
        ./kubectl-gadget deploy --verify-gadgets=false --debug --experimental
    - name: Gadgets tests
      id: gadgets-tests
      shell: bash
      run: |
        set -o pipefail
        make \
        GADGET_TAG=latest \
        KUBECTL_GADGET=/home/runner/work/inspektor-gadget/inspektor-gadget/kubectl-gadget \
        IG_RUNTIME=kubernetes \
        -C gadgets/ test-k8s -o build |& tee gadgets-tests.log & wait $!
    - name: Undeploy Inspektor Gadget
      id: undeploy-ig
      if: always()
      shell: bash
      run: ./kubectl-gadget undeploy
    - name: Prepare and publish test reports
      if: always()
      continue-on-error: true
      uses: ./.github/actions/prepare-and-publish-test-reports
      with:
        test-log-file: gadgets-tests.log
        test-step-conclusion: ${{ steps.gadgets-tests.conclusion }}
        test-summary-suffix: "test-snapshot-proces-${{ matrix.runtime }}"
