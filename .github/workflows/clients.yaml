name: Clients
env:
  REGISTRY: ghcr.io
  CONTAINER_REPO: ${{ github.repository }}
  GO_VERSION: 1.24.2
  # controller-gen with go >1.21 panics, but we can't update controller-gen itself
  GO_VERSION_DOC_CHECK: 1.21.3
  AZURE_AKS_CLUSTER_PREFIX: ig-ci-aks-
  DEFAULT_DNSTESTER_IMAGE: ghcr.io/inspektor-gadget/dnstester:main
  DEFAULT_GADGET_BUILDER_IMAGE: ghcr.io/inspektor-gadget/gadget-builder:main
  # With the recent update of docker/build-push-action to v6, this action
  # started creating docker build summary files (i.e. .dockerbuild).
  # Sadly, these files create troubles when trying to download artifact in the
  # release job as they seem to not be downloadable.
  # So, for now, let's deactivate this feature.
  DOCKER_BUILD_NO_SUMMARY: true
concurrency:
  group: ${{ github.ref }}
  # We do not want to cancel job in progress on main to be sure to catch new
  # regression as soon as they are introduced.
  cancel-in-progress: ${{ github.ref_name != 'main' }}
on:
  pull_request:
  workflow_dispatch:
jobs:
  build-clients:
    name: clients
    # level: 0
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        client: [kubectl-gadget, gadgetctl]
        os: [linux, darwin, windows]
        arch: [amd64, arm64]
        exclude:
          - os: windows
            arch: arm64
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Setup go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
      id: go
    - name: Set container repository and determine image tag
      id: set-repo-determine-image-tag
      uses: ./.github/actions/set-container-repo-and-determine-image-tag
      with:
        registry: ${{ env.REGISTRY }}
        container-image: ${{ env.CONTAINER_REPO }}
    - uses: github/codeql-action/init@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
      with:
        languages: go
    - name: Build ${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}
      env:
        CONTAINER_REPO: ${{ steps.set-repo-determine-image-tag.outputs.container-repo }}
        IMAGE_TAG: ${{ steps.set-repo-determine-image-tag.outputs.image-tag }}
      run: |
        git checkout

        # Prevent releases with -dirty suffix due to forgotten entries in
        # .gitignore.
        changes="$(git status --porcelain)"
        if [ -n "$changes" ] ; then
          echo "$changes"
          exit 1
        fi

        client=${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}
        make "$client"

        # We need to append .exe to windows binaries...
        dot_exe=$(test ${{ matrix.os }} = 'windows' && echo '.exe' || echo '')

        # Prepare assets for release and actions artifacts
        platform='${{ matrix.os }}-${{ matrix.arch }}'
        mkdir "$platform"
        cp "${client}${dot_exe}" "${platform}/${{ matrix.client }}${dot_exe}"
        cp LICENSE "$platform/"
        tar --sort=name --owner=root:0 --group=root:0 \
          -czf "${client}.tar.gz" -C "$platform" \
          ${{ matrix.client }}${dot_exe} LICENSE
        rm -rf "$platform"
    - name: CWE checks for ${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}
      uses: github/codeql-action/analyze@ff0a06e83cb2de871e5a09832bc6a81e7276941f # v3.28.18
      with:
        category: ${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}
    - name: Add ${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz as artifact.
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: ${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}-tar-gz
        path: /home/runner/work/inspektor-gadget/inspektor-gadget/${{ matrix.client }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
